# ADR-0002: 템플릿 라이브러리 설계

| 항목 | 내용 |
|------|------|
| **상태** | Accepted |
| **작성일** | 2024-01-15 |
| **결정자** | 프로젝트 팀 |
| **관련 문서** | [spec-v2.md](../spec-v2.md) Section 6 |

## Context (배경)

사용자가 예시 문서를 업로드하면 해당 양식에 맞는 템플릿을 생성/저장/관리할 수 있어야 합니다.

### 요구사항

1. **예시 → 템플릿**: 고객별 양식을 예시 문서로 등록하면 템플릿으로 변환
2. **버전 관리**: 템플릿 수정 이력 추적
3. **감사 추적**: "이 보고서는 어떤 템플릿으로 생성되었나" 추적 가능
4. **오프라인 작동**: 네트워크 없이도 템플릿 사용 가능

### 고려한 대안들

#### 대안 1: 템플릿 단일 폴더

```
templates/
  customer_a.docx
  customer_b.docx
```

**장점**: 단순함  
**단점**: 원본 보관 불가, 메타데이터 관리 어려움

#### 대안 2: source/compiled 분리 (선택됨)

```
templates/custom/<id>/
  source/      # 원본 (불변)
  compiled/    # 렌더용 (placeholder 포함)
  meta.json
  manifest.yaml
```

**장점**: 감사 추적, 재생성 가능, 메타데이터 분리  
**단점**: 구조 복잡

## Decision (결정)

**source/compiled 분리 구조를 사용한다.**

### 핵심 규칙

| 규칙 | 설명 |
|------|------|
| **source/ 불변** | 사용자가 업로드한 원본은 **절대 수정 금지** (감사용) |
| **compiled/ 렌더용** | 실제 렌더링은 compiled/ 파일만 사용 |
| **meta.json 메타** | 생성일, 작성자, 상태, 버전 등 |
| **manifest.yaml 매핑** | placeholder, Excel 셀 매핑 |

### 폴더 구조

```
templates/
├── base/                    # 팀 표준 (거의 변경 없음)
│   ├── report.docx
│   ├── report.xlsx
│   └── manifest.yaml
│
└── custom/<template_id>/    # 사용자 정의
    ├── source/              # 원본 (불변, 감사용)
    │   ├── example.docx
    │   └── example.xlsx
    ├── compiled/            # 렌더용 (placeholder 포함)
    │   ├── report.docx
    │   └── report.xlsx
    ├── meta.json            # 메타데이터
    └── manifest.yaml        # 매핑 정보
```

### template_id 네이밍 규칙 (규범)

| 규칙 | 예시 | 설명 |
|------|------|------|
| **형식** | `{customer}_{doctype}` | 고객_문서타입 |
| **소문자+언더스코어** | `customer_a_inspection` | camelCase/공백 금지 |
| **버전 포함 시** | `customer_a_inspection_v2` | 끝에 `_v{n}` |
| **길이** | 최대 50자 | 파일시스템 호환 |

**금지 문자**: `/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `|`, 공백

### 버전 관리 정책

```
customer_a_inspection/       # 현재 버전 (active)
customer_a_inspection_v1/    # 이전 버전 (archived)
customer_a_inspection_v2/    # 다음 버전 (draft → active)
```

| 상태 | meta.json status | 설명 |
|------|------------------|------|
| `draft` | 작성 중 | 렌더 불가 |
| `ready` | 사용 가능 | 렌더 가능 |
| `archived` | 폐기됨 | 렌더 불가, 조회만 |

**중복 방지**:
- 동일 template_id 생성 시도 → **에러 (fail-fast)**
- 버전 업데이트 시 → 기존을 `_v{n}`으로 rename 후 새로 생성

### source/ 불변 보호 (코드 가드)

```python
# src/templates/manager.py

def save_source(template_id: str, file_bytes: bytes, filename: str):
    source_dir = TEMPLATES_DIR / template_id / "source"
    target = source_dir / filename
    
    # 불변 가드: 이미 존재하면 에러
    if target.exists():
        raise TemplateError(
            "SOURCE_IMMUTABLE",
            f"source/{filename} already exists. Cannot overwrite."
        )
    
    # 저장 후 readonly 설정 (Unix)
    target.write_bytes(file_bytes)
    target.chmod(0o444)  # r--r--r--
```

> ⚠️ **source/ 덮어쓰기 시도 시 에러 발생**  
> 문서 규칙이 아니라 코드로 강제함.

### 템플릿 생성 2단계

#### 레벨 1: 자동 (안정)

예시 문서에 이미 `{{wo_no}}` 같은 placeholder가 있으면:
→ 그대로 compiled/에 복사

#### 레벨 2: 반자동 (현실 방탄)

예시 문서가 완성본이고 placeholder가 없으면:
1. LLM이 라벨 패턴 감지 ("작업지시:", "Part No:" 등)
2. placeholder 삽입된 초안 생성
3. **사용자 검수/수정 UI** (필수)
4. 확정 후 compiled/에 저장

> ⚠️ **검수 없는 100% 자동 생성은 금지**  
> 유령버그/운영불만의 지름길.

### XLSX 매핑 우선순위

```yaml
xlsx_mappings:
  named_ranges:     # 우선순위 1 (권장)
    wo_no: "WO_NO"
  cell_addresses:   # 우선순위 2 (named_range 없을 때만)
    lot_no: "Sheet1!B4"
```

| 상황 | 동작 |
|------|------|
| named_range만 있음 | named_range 사용 |
| cell_address만 있음 | cell_address 사용 |
| **둘 다 있음** | **에러 (fail-fast)** |

### 측정 테이블 제약

```yaml
measurements:
  start_row: 5  # 시작 행 고정
```

> ⚠️ **템플릿에 행 삽입/삭제/숨김/필터 금지**  
> start_row 기반 매핑이 깨짐.

## Consequences (결과)

### 긍정적 결과

| 결과 | 설명 |
|------|------|
| **감사 추적** | source/ 원본으로 "뭘 기반으로 만들었나" 추적 |
| **재생성 가능** | source/가 있으면 compiled/ 재생성 가능 |
| **안전한 수정** | compiled/만 수정, source/는 보존 |
| **메타데이터 분리** | 버전, 상태, 작성자 등 별도 관리 |

### 부정적 결과 / 위험

| 위험 | 완화 방안 |
|------|-----------|
| **구조 복잡** | 명확한 역할 분리로 학습 곡선 완화 |
| **검수 누락** | UI에서 검수 체크 필수 (체크 없으면 저장 불가) |
| **매핑 오류** | 미리보기 기능으로 저장 전 확인 |

## References

- [spec-v2.md](../spec-v2.md) - Section 6. 템플릿 시스템 상세
- [ADR-0001](./ADR-0001.md) - job.json SSOT (유사 철학)
